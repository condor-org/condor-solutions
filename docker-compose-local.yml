version: "3.9"

networks:
  condor_local_net: {}

services:
  proxy:
    image: condor-proxy:local
    environment:
      PROXY_MODE: "local"
    ports:
      - "127.0.0.1:8080:8080"
    depends_on:
      backend:
        condition: service_healthy
      frontend:
        condition: service_healthy
    restart: always
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - condor_local_net

  backend:
    # ← build local en vez de image GHCR
    build:
      context: ./backend
      dockerfile: docker/Dockerfile
    env_file:
      - .env
    environment:
      DJANGO_SETTINGS_MODULE: "condor_core.settings.dev"
      DJANGO_REQUEST_LOG_LEVEL: "ERROR"
      DJANGO_MIDDLEWARE_LOG_LEVEL: "WARNING"
      DJANGO_LOG_SKIP_CONTAINS: "/api/notificaciones/unread_count/,/api/token/refresh/"
      TZ: "America/Argentina/Buenos_Aires"  # ← Zona horaria de Argentina
    volumes:
      - ./backend:/app  # ← Volumen compartido para desarrollo
      - media_data:/app/media  # ← Volumen persistente para archivos de media
    depends_on:
      - db
      - redis
    restart: always
    mem_limit: "1g"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - condor_local_net
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import http.client,sys; c=http.client.HTTPConnection('localhost',8000,timeout=3); c.request('GET','/'); c.getresponse(); sys.exit(0)\""]
      interval: 5s
      timeout: 3s
      retries: 12
      start_period: 20s

  frontend:
    # ← build local en vez de image GHCR
    build:
      context: ./frontend-padel
      dockerfile: docker/Dockerfile
      args:
        REACT_ENV: "development"
    env_file:
      - .env
    environment:
      PUBLIC_API_BASE_URL: "${PUBLIC_API_BASE_URL}"
      PUBLIC_CLIENTE_ID: "${PUBLIC_CLIENTE_ID}"
      PUBLIC_NOMBRE_CLIENTE: "${PUBLIC_NOMBRE_CLIENTE}"
      PUBLIC_COLOR_PRIMARIO: "${PUBLIC_COLOR_PRIMARIO}"
      PUBLIC_COLOR_SECUNDARIO: "${PUBLIC_COLOR_SECUNDARIO}"
      PUBLIC_GOOGLE_CLIENT_ID: "${PUBLIC_GOOGLE_CLIENT_ID}"
      PUBLIC_OAUTH_REDIRECT_URI: "${PUBLIC_OAUTH_REDIRECT_URI}"
    depends_on:
      - backend
    restart: always
    mem_limit: "256m"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - condor_local_net
    healthcheck:
      test:
        - "CMD-SHELL"
        - "wget -qO- http://localhost || exit 1"
      interval: 15s
      timeout: 5s
      retries: 6
      start_period: 20s

  cron:
    # ← build local en vez de image GHCR
    build:
      context: ./backend
      dockerfile: docker/Dockerfile.cron
    env_file:
      - .env
    environment:
      DJANGO_SETTINGS_MODULE: "condor_core.settings.dev"
      DJANGO_REQUEST_LOG_LEVEL: "ERROR"
      DJANGO_MIDDLEWARE_LOG_LEVEL: "WARNING"
      DJANGO_LOG_SKIP_CONTAINS: "/api/notificaciones/unread_count/,/api/token/refresh/"
    depends_on:
      - db
      - redis
    restart: always
    mem_limit: "512m"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - condor_local_net

  db:
    image: postgres:14
    env_file:
      - .env
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "127.0.0.1:5432:5432"
    restart: always
    mem_limit: "512m"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - condor_local_net

  redis:
    image: redis:7
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - redis_data:/data
    restart: always
    mem_limit: "256m"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - condor_local_net

volumes:
  postgres_data:
    name: condor_postgres_data
  redis_data:
    name: condor_redis_data
  media_data:
    name: condor_media_data