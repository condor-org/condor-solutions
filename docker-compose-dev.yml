version: "3.9"

networks:
  condor_net_dev:
    name: condor_net_dev

volumes:
  postgres_data_dev:
    name: condor_postgres_data_dev
  redis_data_dev:
    name: condor_redis_data_dev

services:
  backend_dev:
    image: ghcr.io/${OWNER}/${IMAGE_PREFIX}-backend:${BACKEND_TAG_DEV}
    container_name: backend_condor_dev
    env_file: [ .env.dev ]
    environment:
      DJANGO_SETTINGS_MODULE: condor_core.settings.dev
    depends_on:
      db_dev:
        condition: service_healthy
      redis_dev:
        condition: service_healthy
    restart: always
    mem_limit: "1g"
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import http.client,sys; c=http.client.HTTPConnection('localhost',8000,timeout=3); c.request('GET','/'); c.getresponse(); sys.exit(0)\""]
      interval: 5s
      timeout: 3s
      retries: 12
      start_period: 20s
    logging:
      driver: json-file
      options: { max-size: "10m", max-file: "3" }
    networks: [condor_net_dev]

  frontend_dev:
    image: ghcr.io/${OWNER}/${IMAGE_PREFIX}-frontend:${FRONTEND_TAG_DEV}
    container_name: frontend_condor_dev
    env_file: [ .env.dev ]
    environment:
      PUBLIC_API_BASE_URL: ${PUBLIC_API_BASE_URL}
      PUBLIC_CLIENTE_ID: ${PUBLIC_CLIENTE_ID}
      PUBLIC_NOMBRE_CLIENTE: ${PUBLIC_NOMBRE_CLIENTE}
      PUBLIC_COLOR_PRIMARIO: ${PUBLIC_COLOR_PRIMARIO}
      PUBLIC_COLOR_SECUNDARIO: ${PUBLIC_COLOR_SECUNDARIO}
      PUBLIC_GOOGLE_CLIENT_ID: ${PUBLIC_GOOGLE_CLIENT_ID}
      PUBLIC_OAUTH_REDIRECT_URI: ${PUBLIC_OAUTH_REDIRECT_URI}
    depends_on:
      backend_dev:
        condition: service_healthy
    restart: always
    mem_limit: "256m"
    healthcheck:
      test: ["CMD-SHELL", "pidof nginx >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10
    logging:
      driver: json-file
      options: { max-size: "10m", max-file: "3" }
    networks: [condor_net_dev]

  cron_dev:
    image: ghcr.io/${OWNER}/${IMAGE_PREFIX}-cron:${CRON_TAG_DEV}
    container_name: cron_condor_dev
    env_file: [ .env.dev ]
    environment:
      DJANGO_SETTINGS_MODULE: condor_core.settings.dev
    depends_on:
      db_dev:
        condition: service_healthy
      redis_dev:
        condition: service_healthy
    restart: always
    mem_limit: "512m"
    logging:
      driver: json-file
      options: { max-size: "10m", max-file: "3" }
    networks: [condor_net_dev]

  db_dev:
    image: postgres:14
    container_name: db_condor_dev
    env_file: [ .env.dev ]
    volumes:
      - postgres_data_dev:/var/lib/postgresql/data
    restart: always
    mem_limit: "512m"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 10
    logging:
      driver: json-file
      options: { max-size: "10m", max-file: "3" }
    networks: [condor_net_dev]

  redis_dev:
    image: redis:7
    container_name: redis_condor_dev
    volumes:
      - redis_data_dev:/data
    restart: always
    mem_limit: "256m"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 10
    logging:
      driver: json-file
      options: { max-size: "10m", max-file: "3" }
    networks: [condor_net_dev]