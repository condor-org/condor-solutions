name: Deploy Condor to EC2

on:
  push:
  workflow_dispatch: {}
  release:
    types: [published]

permissions:
  contents: read
  packages: read

jobs:
  deploy:
    name: Deploy (EC2)
    runs-on: ubuntu-latest

    steps:
      - name: ðŸš€ Conectar por SSH y desplegar
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.EC2_HOST }}          # ej: 18.222.15.118
          username: ${{ vars.EC2_USER }}       # ej: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}         # private key PEM
          port: ${{ var.EC2_SSH_PORT || 22 }}
          script_stop: true
          envs: >
            GHCR_USERNAME,GH_AUTOMATION_TOKEN,DJANGO_SECRET_KEY,DATABASE_URL,
            OWNER,REPO_URL,IMAGE_PREFIX,BACKEND_TAG,FRONTEND_TAG,CRON_TAG,
            PUBLIC_API_BASE_URL,PUBLIC_CLIENTE_ID,PUBLIC_NOMBRE_CLIENTE,
            PUBLIC_COLOR_PRIMARIO,PUBLIC_COLOR_SECUNDARIO,REDIS_URL,
            ALLOWED_HOSTS,CSRF_TRUSTED_ORIGINS
          # --- Mapeo de secrets/vars a env del host remoto ---
          command_timeout: "30m"
          script: |
            set -euo pipefail
            trap 'echo "âŒ Error en lÃ­nea $LINENO" >&2' ERR
            log(){ echo "[$(date -Is)] $*"; }
            fail(){ echo "âŒ $1" >&2; exit 1; }
            req(){ [ -n "${!1:-}" ] || fail "Falta variable requerida: $1"; }

            # ===== Vars desde GitHub (Secrets y Vars) =====
            export GHCR_USERNAME='${{ secrets.GHCR_USERNAME }}'
            export GH_AUTOMATION_TOKEN='${{ secrets.GH_AUTOMATION_TOKEN }}'
            export DJANGO_SECRET_KEY='${{ secrets.DJANGO_SECRET_KEY }}'
            export DATABASE_URL='${{ secrets.DATABASE_URL }}'

            export OWNER='${{ vars.OWNER }}'
            export REPO_URL='${{ vars.REPO_URL }}'
            export IMAGE_PREFIX='${{ vars.IMAGE_PREFIX }}'
            export BACKEND_TAG='${{ vars.BACKEND_TAG }}'
            export FRONTEND_TAG='${{ vars.FRONTEND_TAG }}'
            export CRON_TAG='${{ vars.CRON_TAG }}'

            export PUBLIC_API_BASE_URL='${{ vars.PUBLIC_API_BASE_URL }}'
            export PUBLIC_CLIENTE_ID='${{ vars.PUBLIC_CLIENTE_ID }}'
            export PUBLIC_NOMBRE_CLIENTE='${{ vars.PUBLIC_NOMBRE_CLIENTE }}'
            export PUBLIC_COLOR_PRIMARIO='${{ vars.PUBLIC_COLOR_PRIMARIO }}'
            export PUBLIC_COLOR_SECUNDARIO='${{ vars.PUBLIC_COLOR_SECUNDARIO }}'

            export REDIS_URL='${{ vars.REDIS_URL }}'
            export ALLOWED_HOSTS='${{ vars.ALLOWED_HOSTS }}'
            export CSRF_TRUSTED_ORIGINS='${{ vars.CSRF_TRUSTED_ORIGINS }}'

            # ===== Validaciones tempranas =====
            for v in GHCR_USERNAME GH_AUTOMATION_TOKEN DJANGO_SECRET_KEY DATABASE_URL OWNER REPO_URL \
                     IMAGE_PREFIX BACKEND_TAG FRONTEND_TAG CRON_TAG PUBLIC_API_BASE_URL PUBLIC_CLIENTE_ID \
                     PUBLIC_NOMBRE_CLIENTE PUBLIC_COLOR_PRIMARIO PUBLIC_COLOR_SECUNDARIO REDIS_URL \
                     ALLOWED_HOSTS CSRF_TRUSTED_ORIGINS; do
              req "$v"
            done

            # ===== Paths y dependencias mÃ­nimas =====
            sudo mkdir -p /opt/condor /opt/condor-tmp
            sudo chown -R "$USER":"$USER" /opt/condor /opt/condor-tmp
            cd /opt/condor
            sudo apt-get update -y
            sudo apt-get install -y git curl

            # ===== Cleanup suave (idempotente) =====
            log "[+] Bajar stack si existe (idempotente)"
            if [ -f /opt/condor/docker-compose-prod.yml ] && [ -f /opt/condor/.env.prod ]; then
              docker compose --env-file /opt/condor/.env.prod -f /opt/condor/docker-compose-prod.yml down -v --remove-orphans || true
            else
              docker compose down -v --remove-orphans || true
            fi

            # ===== Clonado autenticado de rama infra =====
            log "[+] Clonando rama infra (con Bearer)"
            rm -rf /opt/condor-tmp/*
            git -c http.extraHeader="Authorization: Bearer ${GH_AUTOMATION_TOKEN}" \
                clone --depth=1 -b infra "${REPO_URL}" /opt/condor-tmp

            [ -f /opt/condor-tmp/docker-compose-prod.yml ] || fail "No se encontrÃ³ docker-compose-prod.yml en rama infra"
            cp /opt/condor-tmp/docker-compose-prod.yml /opt/condor/
            [ -d /opt/condor-tmp/deploy ] && cp -r /opt/condor-tmp/deploy/* /opt/condor/ || true
            rm -rf /opt/condor-tmp

            # ===== Docker login GHCR =====
            log "[+] Docker login GHCR"
            echo "${GH_AUTOMATION_TOKEN}" | sudo docker login ghcr.io -u "${GHCR_USERNAME}" --password-stdin

            # ===== Render .env.prod =====
            log "[+] Render .env.prod"
            cat > .env.prod <<EOF
            DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY}
            DATABASE_URL=${DATABASE_URL}
            ALLOWED_HOSTS=${ALLOWED_HOSTS}
            CSRF_TRUSTED_ORIGINS=${CSRF_TRUSTED_ORIGINS}
            REDIS_URL=${REDIS_URL}

            PUBLIC_API_BASE_URL=${PUBLIC_API_BASE_URL}
            PUBLIC_CLIENTE_ID=${PUBLIC_CLIENTE_ID}
            PUBLIC_NOMBRE_CLIENTE=${PUBLIC_NOMBRE_CLIENTE}
            PUBLIC_COLOR_PRIMARIO=${PUBLIC_COLOR_PRIMARIO}
            PUBLIC_COLOR_SECUNDARIO=${PUBLIC_COLOR_SECUNDARIO}

            OWNER=${OWNER}
            IMAGE_PREFIX=${IMAGE_PREFIX}
            BACKEND_TAG=${BACKEND_TAG}
            FRONTEND_TAG=${FRONTEND_TAG}
            CRON_TAG=${CRON_TAG}
            EOF

            log "[i] Preview .env (sin secretos sensibles)"
            grep -E '^(ALLOWED_HOSTS|CSRF_TRUSTED_ORIGINS|PUBLIC_|OWNER|IMAGE_PREFIX|.*TAG)=' .env.prod || true

            # ===== Validar compose =====
            log "[+] Validando compose"
            sudo docker compose --env-file .env.prod -f docker-compose-prod.yml config >/dev/null

            # ===== Pull & Up =====
            log "[+] Pull imÃ¡genes GHCR"
            sudo docker compose --env-file .env.prod -f docker-compose-prod.yml pull

            log "[+] Levantando stack"
            sudo docker compose --env-file .env.prod -f docker-compose-prod.yml up -d

            # ===== Migraciones y checks =====
            log "[+] Migraciones Django"
            sudo docker compose --env-file .env.prod -f docker-compose-prod.yml exec -T backend python manage.py migrate --noinput

            log "[+] Django check --deploy (no-fail)"
            sudo docker compose --env-file .env.prod -f docker-compose-prod.yml exec -T backend python manage.py check --deploy || true

            # ===== Smoke tests =====
            log "[+] Smoke /healthz"
            curl -fsS http://localhost:8080/healthz
            curl -fsS http://localhost:8080/api/healthz || true

            log "[âœ“] Deploy OK"
