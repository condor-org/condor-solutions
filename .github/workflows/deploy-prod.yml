name: Deploy Condor (prod)

on:
  workflow_dispatch: {}
  release:
    types: [published]
  push:
    branches: [ infra ]

permissions:
  contents: read
  packages: read

env:
  OWNER: ${{ vars.OWNER }}
  IMAGE_PREFIX: ${{ vars.IMAGE_PREFIX }}
  BACKEND_TAG: ${{ vars.BACKEND_TAG }}
  FRONTEND_TAG: ${{ vars.FRONTEND_TAG }}
  CRON_TAG: ${{ vars.CRON_TAG }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: Conectar a EC2 y desplegar
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.EC2_HOST }}
          username: ${{ vars.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euo pipefail
            trap 'echo "❌ Error en línea $LINENO" >&2' ERR

            cd /opt/condor

            echo "[+] Sync repo (branch infra)"
            if [ ! -d .git ]; then
              git init
              git remote add origin "https://x-access-token:${{ secrets.GH_AUTOMATION_TOKEN }}@github.com/condor-ai-solutions/condor.git"
            else
              git remote set-url origin "https://x-access-token:${{ secrets.GH_AUTOMATION_TOKEN }}@github.com/condor-ai-solutions/condor.git"
            fi
            git fetch --all --prune
            git checkout -B infra origin/infra
            git reset --hard origin/infra
            git rev-parse --abbrev-ref HEAD
            git log -1 --oneline

            echo "[+] Docker login GHCR"
            echo "${{ secrets.GH_AUTOMATION_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin

            echo "[+] Render .env.prod"
            # SIN comillas en los colores; DJANGO_ALLOWED_HOSTS correcto
            cat > .env.prod <<EOF
            DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
            DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1,${{ vars.ALLOWED_HOSTS }}
            CSRF_TRUSTED_ORIGINS=${{ vars.CSRF_TRUSTED_ORIGINS }}
            DJANGO_ENV=prod
            DJANGO_SECURE_SSL_REDIRECT=False
            DJANGO_HSTS_SECONDS=0

            REDIS_URL=${{ vars.REDIS_URL }}

            # Frontend runtime-config
            PUBLIC_API_BASE_URL=${{ vars.PUBLIC_API_BASE_URL }}
            PUBLIC_CLIENTE_ID=${{ vars.PUBLIC_CLIENTE_ID }}
            PUBLIC_NOMBRE_CLIENTE=${{ vars.PUBLIC_NOMBRE_CLIENTE }}
            PUBLIC_COLOR_PRIMARIO=${{ vars.PUBLIC_COLOR_PRIMARIO }}
            PUBLIC_COLOR_SECUNDARIO=${{ vars.PUBLIC_COLOR_SECUNDARIO }}

            # Postgres (RDS)
            POSTGRES_DB=${{ vars.POSTGRES_DB }}
            POSTGRES_USER=${{ vars.POSTGRES_USER }}
            POSTGRES_HOST=${{ vars.POSTGRES_HOST }}
            POSTGRES_PORT=${{ vars.POSTGRES_PORT }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}

            # Imágenes
            OWNER=${{ env.OWNER }}
            IMAGE_PREFIX=${{ env.IMAGE_PREFIX }}
            BACKEND_TAG=${{ env.BACKEND_TAG }}
            FRONTEND_TAG=${{ env.FRONTEND_TAG }}
            CRON_TAG=${{ env.CRON_TAG }}
            EOF

            echo "[+] Verificando compose"
            test -f docker-compose-prod.yml || { echo "FALTA docker-compose-prod.yml"; ls -la; exit 2; }

            echo "[+] Pull imágenes"
            docker compose --env-file .env.prod -f docker-compose-prod.yml pull

            echo "[+] Levantando stack (force-recreate para aplicar envs)"
            docker compose --env-file .env.prod -f docker-compose-prod.yml up -d --force-recreate

            echo "[+] Esperando servicios healthy"
            for i in $(seq 1 40); do
              B=$(docker inspect -f '{{.State.Health.Status}}' backend_condor 2>/dev/null || echo "starting")
              F=$(docker inspect -f '{{.State.Health.Status}}' frontend_condor 2>/dev/null || echo "starting")
              echo "  backend=$B | frontend=$F"
              if [ "$B" = "healthy" ] && [ "$F" = "healthy" ]; then break; fi
              sleep 3
            done

            echo "[+] Migraciones y checks"
            docker compose --env-file .env.prod -f docker-compose-prod.yml exec -T backend python manage.py migrate --noinput
            docker compose --env-file .env.prod -f docker-compose-prod.yml exec -T backend python manage.py check --deploy || true

            echo "[+] Smoke tests (proxy en :80)"
            # health del proxy
            curl -fsS http://localhost/healthz >/dev/null
            # si tenés /api/healthz en backend, validalo; si no, no falla
            curl -fsS http://localhost/api/healthz >/dev/null || true

            echo "[✓] Deploy OK"
