name: Deploy Condor (prod)

on:
  workflow_dispatch:
  release:
    types: [published]
  push:
    branches: [ infra ]

permissions:
  contents: read
  packages: read

env:
  OWNER: ${{ vars.OWNER }}
  IMAGE_PREFIX: ${{ vars.IMAGE_PREFIX }}
  BACKEND_TAG: ${{ vars.BACKEND_TAG }}
  FRONTEND_TAG: ${{ vars.FRONTEND_TAG }}
  CRON_TAG: ${{ vars.CRON_TAG }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: Conectar a EC2 y desplegar
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.EC2_HOST }}
          username: ${{ vars.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 30s
          command_timeout: 15m
          script: |
            set -euo pipefail
            log(){ echo "[$(date -Is)] $*"; }
            fail(){ echo "❌ $1" >&2; exit 1; }

            # --- Validaciones tempranas ---
            [ -n "${{ secrets.GHCR_USERNAME }}" ]           || fail "Falta secret GHCR_USERNAME"
            [ -n "${{ secrets.GH_AUTOMATION_TOKEN }}" ]     || fail "Falta secret GH_AUTOMATION_TOKEN"
            [ -n "${{ secrets.DJANGO_SECRET_KEY }}" ]       || fail "Falta secret DJANGO_SECRET_KEY"
            [ -n "${{ secrets.DATABASE_URL }}" ]            || fail "Falta secret DATABASE_URL"
            [ -n "${{ vars.OWNER }}" ]                      || fail "Falta var OWNER"
            [ -n "${{ vars.IMAGE_PREFIX }}" ]               || fail "Falta var IMAGE_PREFIX"
            [ -n "${{ vars.BACKEND_TAG }}" ]                || fail "Falta var BACKEND_TAG"
            [ -n "${{ vars.FRONTEND_TAG }}" ]               || fail "Falta var FRONTEND_TAG"
            [ -n "${{ vars.CRON_TAG }}" ]                   || fail "Falta var CRON_TAG"
            [ -n "${{ vars.PUBLIC_API_BASE_URL }}" ]        || fail "Falta var PUBLIC_API_BASE_URL"
            [ -n "${{ vars.PUBLIC_CLIENTE_ID }}" ]          || fail "Falta var PUBLIC_CLIENTE_ID"
            [ -n "${{ vars.PUBLIC_NOMBRE_CLIENTE }}" ]      || fail "Falta var PUBLIC_NOMBRE_CLIENTE"
            [ -n "${{ vars.PUBLIC_COLOR_PRIMARIO }}" ]      || fail "Falta var PUBLIC_COLOR_PRIMARIO"
            [ -n "${{ vars.PUBLIC_COLOR_SECUNDARIO }}" ]    || fail "Falta var PUBLIC_COLOR_SECUNDARIO"
            [ -n "${{ vars.REDIS_URL }}" ]                  || fail "Falta var REDIS_URL"
            [ -n "${{ vars.ALLOWED_HOSTS }}" ]              || fail "Falta var ALLOWED_HOSTS"
            [ -n "${{ vars.CSRF_TRUSTED_ORIGINS }}" ]       || fail "Falta var CSRF_TRUSTED_ORIGINS"
            [ -n "${{ vars.REPO_URL }}" ]                   || fail "Falta var REPO_URL (https://github.com/org/repo.git)"

            # --- Preparar paths y ownership ---
            sudo mkdir -p /opt/condor /opt/condor-tmp
            sudo chown -R "$(whoami)":"$(whoami)" /opt/condor /opt/condor-tmp

            cd /opt/condor

            # --- Clonar rama infra a /opt/condor-tmp y copiar artefactos ---
            log "[+] Clonando rama infra a /opt/condor-tmp"
            sudo apt-get update -y && sudo apt-get install -y git
            rm -rf /opt/condor-tmp/*
            git clone --depth=1 -b infra "${{ vars.REPO_URL }}" /opt/condor-tmp

            if [ -f /opt/condor-tmp/docker-compose-prod.yml ]; then
              cp /opt/condor-tmp/docker-compose-prod.yml /opt/condor/
            else
              fail "No se encontró docker-compose-prod.yml en la rama infra del repo"
            fi
            if [ -d /opt/condor-tmp/deploy ]; then
              cp -r /opt/condor-tmp/deploy/* /opt/condor/ || true
            fi
            rm -rf /opt/condor-tmp

            log "[+] Docker login GHCR"
            echo "${{ secrets.GH_AUTOMATION_TOKEN }}" | sudo docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin

            log "[+] Render .env.prod"
            cat > .env.prod <<'EOF'
            DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            ALLOWED_HOSTS=${{ vars.ALLOWED_HOSTS }}
            CSRF_TRUSTED_ORIGINS=${{ vars.CSRF_TRUSTED_ORIGINS }}
            REDIS_URL=${{ vars.REDIS_URL }}

            PUBLIC_API_BASE_URL=${{ vars.PUBLIC_API_BASE_URL }}
            PUBLIC_CLIENTE_ID=${{ vars.PUBLIC_CLIENTE_ID }}
            PUBLIC_NOMBRE_CLIENTE=${{ vars.PUBLIC_NOMBRE_CLIENTE }}
            PUBLIC_COLOR_PRIMARIO="${{ vars.PUBLIC_COLOR_PRIMARIO }}"
            PUBLIC_COLOR_SECUNDARIO="${{ vars.PUBLIC_COLOR_SECUNDARIO }}"

            OWNER=${{ env.OWNER }}
            IMAGE_PREFIX=${{ env.IMAGE_PREFIX }}
            BACKEND_TAG=${{ env.BACKEND_TAG }}
            FRONTEND_TAG=${{ env.FRONTEND_TAG }}
            CRON_TAG=${{ env.CRON_TAG }}
            EOF

            log "[i] Preview .env (sin secretos)"
            grep -E '^(ALLOWED_HOSTS|CSRF_TRUSTED_ORIGINS|PUBLIC_|OWNER|IMAGE_PREFIX|.*TAG)=' .env.prod || true

            log "[+] Validando compose"
            sudo docker compose --env-file .env.prod -f docker-compose-prod.yml config >/dev/null

            log "[+] Pull imágenes"
            sudo docker compose --env-file .env.prod -f docker-compose-prod.yml pull

            log "[+] Levantando stack"
            sudo docker compose --env-file .env.prod -f docker-compose-prod.yml up -d

            log "[+] Migraciones"
            sudo docker compose --env-file .env.prod -f docker-compose-prod.yml exec -T backend python manage.py migrate --noinput

            log "[+] Django check --deploy"
            sudo docker compose --env-file .env.prod -f docker-compose-prod.yml exec -T backend python manage.py check --deploy || true

            # sudo docker compose --env-file .env.prod -f docker-compose-prod.yml exec -T backend python manage.py collectstatic --noinput

            log "[+] Smoke tests"
            curl -fsS http://localhost:8080/healthz
            curl -fsS http://localhost:8080/api/healthz || true

            log "[✓] Deploy OK"
