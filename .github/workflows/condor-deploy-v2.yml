name: Condor Deploy

run-name: Deploy ${{ inputs.environment || 'auto' }} - ${{ inputs.release_tag || github.event.release.tag_name || 'latest' }}

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente a deployar'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      release_tag:
        description: 'Tag específico a usar (opcional)'
        required: false
        type: string
      run_bootstrap:
        description: 'Ejecutar bootstrap_condor después del deploy'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  OWNER: ${{ github.repository_owner }}
  LETSENCRYPT_EMAIL: ${{ vars.LETSENCRYPT_EMAIL || 'admin@cnd-ia.com' }}

jobs:
  get-latest-release:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && !inputs.release_tag
    outputs:
      latest_tag: ${{ steps.get-tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
      - name: Get latest release tag
        id: get-tag
        run: |
          LATEST_TAG=$(gh release list --limit 1 --json tagName -q '.[0].tagName')
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Ultimo release: $LATEST_TAG"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-dev:
    runs-on: ubuntu-latest
    needs: [get-latest-release]
    if: always() && (needs.get-latest-release.result == 'success' || needs.get-latest-release.result == 'skipped') && (github.event_name == 'workflow_dispatch' && inputs.environment == 'dev') || (github.event_name == 'release' && (contains(github.event.release.tag_name, 'dev') || contains(github.event.release.tag_name, 'beta') || contains(github.event.release.tag_name, 'alpha')))
    environment: dev
    name: Deploy DEV - ${{ github.event_name == 'workflow_dispatch' && (inputs.release_tag || needs.get-latest-release.outputs.latest_tag) || github.event.release.tag_name }}
    env:
      RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && (inputs.release_tag || needs.get-latest-release.outputs.latest_tag) || github.event.release.tag_name }}
    steps:
      - name: Deploy a DEV
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.EC2_HOST }}
          username: ${{ vars.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 30s
          command_timeout: 10m
          script: |
            set -euo pipefail
            trap 'echo "Error en linea $LINENO" >&2' ERR
            cd /opt/condor

            echo "[+] Deploy DEV - Parámetros"
            echo "    TAG=${{ env.RELEASE_TAG }}"
            echo "    ENVIRONMENT=dev"
            TOKEN="${{ secrets.GH_AUTOMATION_TOKEN }}"
            REPO="condor-ai-solutions/condor"
            OWNER_LC=$(echo "${{ env.OWNER }}" | tr '[:upper:]' '[:lower:]')
            RETAIN=5

            echo "[+] Backup compose DEV (rotación: $RETAIN)"
            if [ -f docker-compose-dev.yml ]; then
              cp -a docker-compose-dev.yml docker-compose-dev.yml.bak.$(date +%F_%H%M%S)
              ls -1t docker-compose-dev.yml.bak.* 2>/dev/null | tail -n +$((RETAIN+1)) | xargs -r rm -f
            fi

            echo "[+] Descargar docker-compose-dev.yml (repo@${{ github.sha }})"
            curl -fsSL \
              -H "Authorization: token ${TOKEN}" \
              -H "Accept: application/vnd.github.raw" \
              "https://api.github.com/repos/${REPO}/contents/docker-compose/docker-compose-dev.yml?ref=${{ github.sha }}" \
              -o docker-compose-dev.yml

            echo "[+] Docker login GHCR"
            echo "${{ secrets.GH_AUTOMATION_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin

            echo "[+] Generar .env.dev automáticamente"
            cat > .env.dev << 'EOF'
            DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
            DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1,${{ vars.ALLOWED_HOSTS }}
            CSRF_TRUSTED_ORIGINS=${{ vars.CSRF_TRUSTED_ORIGINS }}
            DJANGO_ENV=dev
            DJANGO_SECURE_SSL_REDIRECT=False
            DJANGO_HSTS_SECONDS=0
            REDIS_URL=${{ vars.REDIS_URL }}
            PUBLIC_API_BASE_URL=${{ vars.PUBLIC_API_BASE_URL }}
            PUBLIC_CLIENTE_ID=${{ vars.PUBLIC_CLIENTE_ID }}
            PUBLIC_NOMBRE_CLIENTE=${{ vars.PUBLIC_NOMBRE_CLIENTE }}
            PUBLIC_COLOR_PRIMARIO=${{ vars.PUBLIC_COLOR_PRIMARIO }}
            PUBLIC_COLOR_SECUNDARIO=${{ vars.PUBLIC_COLOR_SECUNDARIO }}
            POSTGRES_DB=${{ vars.POSTGRES_DB }}
            POSTGRES_USER=${{ vars.POSTGRES_USER }}
            POSTGRES_HOST=${{ vars.POSTGRES_HOST }}
            POSTGRES_PORT=${{ vars.POSTGRES_PORT }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            OWNER=${{ env.OWNER }}
            IMAGE_PREFIX=condor
            BACKEND_TAG_DEV=${{ env.RELEASE_TAG }}
            FRONTEND_TAG_DEV=${{ env.RELEASE_TAG }}
            CRON_TAG_DEV=${{ env.RELEASE_TAG }}
            GCP_SA_CLIENT_EMAIL=${{ secrets.GCP_SA_CLIENT_EMAIL }}
            GCP_SA_PROJECT_ID=${{ secrets.GCP_SA_PROJECT_ID }}
            GOOGLE_CREDS=${{ secrets.GOOGLE_CREDS }}
            VISION_OCR_BUCKET=${{ secrets.VISION_OCR_BUCKET }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            STATE_HMAC_SECRET=${{ secrets.STATE_HMAC_SECRET }}
            GOOGLE_ISSUER=${{ vars.GOOGLE_ISSUER }}
            GOOGLE_JWKS_URL=${{ vars.GOOGLE_JWKS_URL }}
            OAUTH_REDIRECT_URI=${{ vars.OAUTH_REDIRECT_URI }}
            FEATURE_OAUTH_INVITES=${{ vars.FEATURE_OAUTH_INVITES }}
            OAUTH_AUTO_PROVISION=${{ vars.OAUTH_AUTO_PROVISION }}
            OAUTH_ALLOWED_EMAIL_DOMAIN=${{ vars.OAUTH_ALLOWED_EMAIL_DOMAIN }}
            NOTIF_EMAIL_ENABLED=${{ vars.NOTIF_EMAIL_ENABLED }}
            PUBLIC_GOOGLE_CLIENT_ID=${{ secrets.PUBLIC_GOOGLE_CLIENT_ID }}
            PUBLIC_OAUTH_REDIRECT_URI=${{ vars.PUBLIC_OAUTH_REDIRECT_URI }}
            BOOTSTRAP_DOMAINS=padel-dev.cnd-ia.com
            EOF


            echo "[+] Preparar credencial Cloudflare para certbot (DNS-01)"
            mkdir -p letsencrypt
            cat > letsencrypt/cloudflare.ini <<'EOF'
            dns_cloudflare_api_token=${{ secrets.CF_DNS_API_TOKEN }}
            EOF
            chmod 600 letsencrypt/cloudflare.ini

            echo "[+] Asegurar volumen de certificados (docker)"
            docker volume inspect condor_certbot_etc >/dev/null 2>&1 || docker volume create --name condor_certbot_etc >/dev/null

            echo "[+] Emitir/renovar wildcard (*.cnd-ia.com) con Certbot (DNS-01 Cloudflare)"
            docker run --rm \
              -v condor_certbot_etc:/etc/letsencrypt \
              -v "$PWD/letsencrypt:/secrets:ro" \
              certbot/dns-cloudflare:latest certonly \
                --dns-cloudflare \
                --dns-cloudflare-credentials /secrets/cloudflare.ini \
                -d cnd-ia.com -d '*.cnd-ia.com' \
                --agree-tos --non-interactive \
                -m '${{ env.LETSENCRYPT_EMAIL }}' || true

            echo "[+] Asegurar networks externas (prod/dev) si no existen"
            docker network inspect condor_net >/dev/null 2>&1 || docker network create condor_net >/dev/null
            docker network inspect condor_net_dev >/dev/null 2>&1 || docker network create condor_net_dev >/dev/null

            echo "[+] Pull de imágenes DEV"
            docker compose -p condor_dev --env-file .env.dev -f docker-compose-dev.yml pull

            echo "[+] Levantando stack DEV"
            docker compose -p condor_dev --env-file .env.dev -f docker-compose-dev.yml up -d --force-recreate

            echo "[+] Esperando servicios healthy (BE/FE DEV)"
            for i in $(seq 1 40); do
              B=$(docker inspect -f '{{.State.Health.Status}}' backend_condor_dev 2>/dev/null || echo "starting")
              F=$(docker inspect -f '{{.State.Health.Status}}' frontend_condor_dev 2>/dev/null || echo "starting")
              echo "  backend_dev=$B | frontend_dev=$F"
              if [ "$B" = "healthy" ] && [ "$F" = "healthy" ]; then break; fi
              sleep 3
            done

            echo "[+] Migraciones DEV"
            docker compose -p condor_dev --env-file .env.dev -f docker-compose-dev.yml exec -T backend_dev python manage.py migrate --noinput

            if [ "${{ inputs.run_bootstrap }}" = "true" ]; then
              echo "[+] Bootstrap Condor DEV"
              docker compose -p condor_dev --env-file .env.dev -f docker-compose-dev.yml exec -T backend_dev python manage.py bootstrap_condor
            else
              echo "[+] Bootstrap Condor DEV - SKIPPED (run_bootstrap=false)"
            fi

            echo "[+] Limpieza de imágenes no usadas (DEV)"
            CURRENT_IMAGES=$(docker ps --format '{{.Image}}' | sort -u)
            ALL_IMAGES=$(docker images --format '{{.Repository}}:{{.Tag}}' "ghcr.io/${OWNER_LC}/condor-*")
            for IMG in $ALL_IMAGES; do
              if echo "$IMG" | grep -q ":${{ env.RELEASE_TAG }}$"; then continue; fi
              if echo "$CURRENT_IMAGES" | grep -qx "$IMG"; then continue; fi
              echo " - borrando $IMG"
              docker rmi -f "$IMG" || true
            done
            docker image prune -f >/dev/null || true

            echo "[+] Reload nginx proxy para re-resolver upstreams"
            docker exec proxy_condor nginx -s reload || echo "Proxy no encontrado, continuando..."

            echo "[✓] Deploy DEV OK"

  deploy-prod:
    runs-on: ubuntu-latest
    needs: [get-latest-release]
    if: always() && (needs.get-latest-release.result == 'success' || needs.get-latest-release.result == 'skipped') && (github.event_name == 'workflow_dispatch' && inputs.environment == 'prod') || (github.event_name == 'release' && !contains(github.event.release.tag_name, 'dev') && !contains(github.event.release.tag_name, 'beta') && !contains(github.event.release.tag_name, 'alpha'))
    environment: prod
    name: Deploy PROD - ${{ github.event_name == 'workflow_dispatch' && (inputs.release_tag || needs.get-latest-release.outputs.latest_tag) || github.event.release.tag_name }}
    env:
      RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && (inputs.release_tag || needs.get-latest-release.outputs.latest_tag) || github.event.release.tag_name }}
    steps:
      - name: Deploy a PROD
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.EC2_HOST }}
          username: ${{ vars.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 30s
          command_timeout: 10m
          script: |
            set -euo pipefail
            trap 'echo "Error en linea $LINENO" >&2' ERR
            cd /opt/condor

            echo "[+] Deploy PROD - Parámetros"
            echo "    TAG=${{ env.RELEASE_TAG }}"
            echo "    ENVIRONMENT=prod"
            TOKEN="${{ secrets.GH_AUTOMATION_TOKEN }}"
            REPO="condor-ai-solutions/condor"
            OWNER_LC=$(echo "${{ env.OWNER }}" | tr '[:upper:]' '[:lower:]')
            RETAIN=5

            echo "[+] Backup compose PROD (rotación: $RETAIN)"
            if [ -f docker-compose-prod.yml ];then
              cp -a docker-compose-prod.yml docker-compose-prod.yml.bak.$(date +%F_%H%M%S)
              ls -1t docker-compose-prod.yml.bak.* 2>/dev/null | tail -n +$((RETAIN+1)) | xargs -r rm -f
            fi

            echo "[+] Descargar docker-compose-prod.yml (repo@${{ github.sha }})"
            curl -fsSL \
              -H "Authorization: token ${TOKEN}" \
              -H "Accept: application/vnd.github.raw" \
              "https://api.github.com/repos/${REPO}/contents/docker-compose/docker-compose-prod.yml?ref=${{ github.sha }}" \
              -o docker-compose-prod.yml

            echo "[+] Docker login GHCR"
            echo "${{ secrets.GH_AUTOMATION_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin

            echo "[+] Generar .env.prod automáticamente"
            cat > .env.prod << 'EOF'
            DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
            DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1,${{ vars.ALLOWED_HOSTS }}
            CSRF_TRUSTED_ORIGINS=${{ vars.CSRF_TRUSTED_ORIGINS }}
            DJANGO_ENV=prod
            DJANGO_SECURE_SSL_REDIRECT=False
            DJANGO_HSTS_SECONDS=0
            REDIS_URL=${{ vars.REDIS_URL }}
            PUBLIC_API_BASE_URL=${{ vars.PUBLIC_API_BASE_URL }}
            PUBLIC_CLIENTE_ID=${{ vars.PUBLIC_CLIENTE_ID }}
            PUBLIC_NOMBRE_CLIENTE=${{ vars.PUBLIC_NOMBRE_CLIENTE }}
            PUBLIC_COLOR_PRIMARIO=${{ vars.PUBLIC_COLOR_PRIMARIO }}
            PUBLIC_COLOR_SECUNDARIO=${{ vars.PUBLIC_COLOR_SECUNDARIO }}
            POSTGRES_DB=${{ vars.POSTGRES_DB }}
            POSTGRES_USER=${{ vars.POSTGRES_USER }}
            POSTGRES_HOST=${{ vars.POSTGRES_HOST }}
            POSTGRES_PORT=${{ vars.POSTGRES_PORT }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            OWNER=${{ env.OWNER }}
            IMAGE_PREFIX=condor
            BACKEND_TAG=${{ env.RELEASE_TAG }}
            FRONTEND_TAG=${{ env.RELEASE_TAG }}
            CRON_TAG=${{ env.RELEASE_TAG }}
            GCP_SA_CLIENT_EMAIL=${{ secrets.GCP_SA_CLIENT_EMAIL }}
            GCP_SA_PROJECT_ID=${{ secrets.GCP_SA_PROJECT_ID }}
            GOOGLE_CREDS=${{ secrets.GOOGLE_CREDS }}
            VISION_OCR_BUCKET=${{ secrets.VISION_OCR_BUCKET }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            STATE_HMAC_SECRET=${{ secrets.STATE_HMAC_SECRET }}
            GOOGLE_ISSUER=${{ vars.GOOGLE_ISSUER }}
            GOOGLE_JWKS_URL=${{ vars.GOOGLE_JWKS_URL }}
            OAUTH_REDIRECT_URI=${{ vars.OAUTH_REDIRECT_URI }}
            FEATURE_OAUTH_INVITES=${{ vars.FEATURE_OAUTH_INVITES }}
            OAUTH_AUTO_PROVISION=${{ vars.OAUTH_AUTO_PROVISION }}
            OAUTH_ALLOWED_EMAIL_DOMAIN=${{ vars.OAUTH_ALLOWED_EMAIL_DOMAIN }}
            NOTIF_EMAIL_ENABLED=${{ vars.NOTIF_EMAIL_ENABLED }}
            PUBLIC_GOOGLE_CLIENT_ID=${{ secrets.PUBLIC_GOOGLE_CLIENT_ID }}
            PUBLIC_OAUTH_REDIRECT_URI=${{ vars.PUBLIC_OAUTH_REDIRECT_URI }}
            BOOTSTRAP_DOMAINS=lob-padel.cnd-ia.com
            EOF

            echo "[+] Preparar credencial Cloudflare para certbot (DNS-01)"
            mkdir -p letsencrypt
            cat > letsencrypt/cloudflare.ini <<'EOF'
            dns_cloudflare_api_token=${{ secrets.CF_DNS_API_TOKEN }}
            EOF
            chmod 600 letsencrypt/cloudflare.ini

            echo "[+] Asegurar volumen de certificados (docker)"
            docker volume inspect condor_certbot_etc >/dev/null 2>&1 || docker volume create --name condor_certbot_etc >/dev/null

            echo "[+] Emitir/renovar wildcard (*.cnd-ia.com) con Certbot (DNS-01 Cloudflare)"
            docker run --rm \
              -v condor_certbot_etc:/etc/letsencrypt \
              -v "$PWD/letsencrypt:/secrets:ro" \
              certbot/dns-cloudflare:latest certonly \
                --dns-cloudflare \
                --dns-cloudflare-credentials /secrets/cloudflare.ini \
                -d cnd-ia.com -d '*.cnd-ia.com' \
                --agree-tos --non-interactive \
                -m '${{ env.LETSENCRYPT_EMAIL }}' || true


            echo "[+] Asegurar networks externas (prod/dev) si no existen"
            docker network inspect condor_net >/dev/null 2>&1 || docker network create condor_net >/dev/null
            docker network inspect condor_net_dev >/dev/null 2>&1 || docker network create condor_net_dev >/dev/null

            echo "[+] Pull de imágenes PROD"
            docker compose -p condor_prod --env-file .env.prod -f docker-compose-prod.yml pull

            echo "[+] Levantando stack PROD"
            docker compose -p condor_prod --env-file .env.prod -f docker-compose-prod.yml up -d --force-recreate

            echo "[+] Esperando servicios healthy (BE/FE PROD)"
            for i in $(seq 1 40); do
              B=$(docker inspect -f '{{.State.Health.Status}}' condor_prod-backend 2>/dev/null || echo "starting")
              F=$(docker inspect -f '{{.State.Health.Status}}' condor_prod-frontend 2>/dev/null || echo "starting")
              echo "  backend=$B | frontend=$F"
              if [ "$B" = "healthy" ] && [ "$F" = "healthy" ]; then break; fi
              sleep 3
            done

            echo "[+] Migraciones PROD"
            docker compose -p condor_prod --env-file .env.prod -f docker-compose-prod.yml exec -T backend python manage.py migrate --noinput

            if [ "${{ inputs.run_bootstrap }}" = "true" ]; then
              echo "[+] Bootstrap Condor PROD"
              docker compose -p condor_prod --env-file .env.prod -f docker-compose-prod.yml exec -T backend python manage.py bootstrap_condor
            else
              echo "[+] Bootstrap Condor PROD - SKIPPED (run_bootstrap=false)"
            fi

            echo "[+] Limpieza de imágenes no usadas (PROD)"
            CURRENT_IMAGES=$(docker ps --format '{{.Image}}' | sort -u)
            ALL_IMAGES=$(docker images --format '{{.Repository}}:{{.Tag}}' "ghcr.io/${OWNER_LC}/condor-*")
            for IMG in $ALL_IMAGES; do
              if echo "$IMG" | grep -q ":${{ env.RELEASE_TAG }}$"; then continue; fi
              if echo "$CURRENT_IMAGES" | grep -qx "$IMG"; then continue; fi
              echo " - borrando $IMG"
              docker rmi -f "$IMG" || true
            done
            docker image prune -f >/dev/null || true

            echo "[+] Reload nginx proxy para re-resolver upstreams"
            docker exec proxy_condor nginx -s reload || echo "Proxy no encontrado, continuando..."

            echo "[✓] Deploy PROD OK"