events {}

http {
  # ========================================
  # CONFIGURACIÓN GLOBAL NGINX
  # ========================================
  
  # Formato de logs detallado para debugging multi-tenant
  # Incluye timing de upstreams para detectar problemas de rendimiento
  log_format upstream_timing '$remote_addr - $remote_user [$time_local] "$request" '
                             '$status $body_bytes_sent "$http_referer" "$http_user_agent" '
                             'rt=$request_time urt=$upstream_response_time uct=$upstream_connect_time uht=$upstream_header_time';
  access_log /dev/stdout upstream_timing;
  error_log  /dev/stderr warn;

  # Optimizaciones de rendimiento
  sendfile on;                    # Usar sendfile para archivos estáticos
  tcp_nopush on;                  # Optimizar envío de paquetes TCP
  client_max_body_size 25m;       # Límite para uploads (comprobantes, etc.)

  # Compresión gzip para reducir ancho de banda
  gzip on;
  gzip_types text/plain text/css application/json application/javascript application/xml+rss image/svg+xml;
  gzip_min_length 1024;

  # ========================================
  # UPSTREAMS (Servicios Backend)
  # ========================================
  # Definición de los servicios internos de Docker
  upstream frontend { server frontend:80; }  # React app
  upstream backend  { server backend:8000; } # Django API

  # Mapeo para WebSockets (notificaciones en tiempo real)
  map $http_upgrade $connection_upgrade { default upgrade; '' close; }

  # ========================================
  # SERVER 1: LUCAS PADEL (localhost:8080)
  # ========================================
  # Simula el cliente "Lucas Padel" en producción
  # En producción sería: padel.cnd-ia.com
  server {
    listen 8080;
    server_name localhost;
    
    # ========================================
    # CONFIGURACIÓN MULTI-TENANT POR SUBDOMINIO
    # ========================================
    # Este servidor responde solo a lucas.localhost:8080
    # El header X-Tenant-Host le dice al backend qué cliente es
    # El backend usa este header para determinar request.cliente_actual
    
    # Healthcheck del proxy (para monitoreo)
    location = /healthz { return 200 "ok\n"; }

    # ========================================
    # RUTAS API → BACKEND
    # ========================================
    # Todas las peticiones /api/* van al backend Django
    # El backend detecta el cliente por el header X-Tenant-Host
    location /api/ {
      proxy_pass http://backend;
      proxy_http_version 1.1;

      # Timeouts para operaciones largas (generación de reportes, etc.)
      proxy_read_timeout 180s;      # 3 minutos para operaciones pesadas
      proxy_connect_timeout 5s;     # 5 segundos para conectar
      proxy_send_timeout 30s;       # 30 segundos para enviar

      # ========================================
      # HEADERS MULTI-TENANT CRÍTICOS
      # ========================================
      # Estos headers son fundamentales para el sistema multi-tenant
      proxy_set_header Host $host;                    # Host original (lucas.localhost:8080)
      proxy_set_header X-Real-IP $remote_addr;        # IP real del cliente
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # Cadena de proxies
      proxy_set_header X-Forwarded-Proto $scheme;      # HTTP/HTTPS
      proxy_set_header X-Forwarded-Port $server_port;  # Puerto (8080)
      
      # ========================================
      # HEADER CLAVE PARA MULTI-TENANT
      # ========================================
      # Este header le dice al backend qué cliente es
      # El TenantMiddleware lo usa para determinar request.cliente_actual
      proxy_set_header X-Tenant-Host "lucas.localhost";

      # WebSockets para notificaciones en tiempo real
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
    }

    # ========================================
    # RUTAS FRONTEND → REACT
    # ========================================
    # Todo lo demás (/, /login, /dashboard, etc.) va al frontend React
    # El frontend maneja el routing del SPA
    location / {
      proxy_pass http://frontend;
      proxy_http_version 1.1;

      # Headers básicos para el frontend
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Port $server_port;
    }

    # Headers de seguridad básicos
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy no-referrer-when-downgrade always;
  }

  # ========================================
  # SERVER 2: DISTRITO PADEL (localhost:8081)
  # ========================================
  # Simula el cliente "Distrito Padel" en producción
  # En producción sería: distrito-padel.com
  server {
    listen 8081;
    server_name localhost;
    
    # ========================================
    # CONFIGURACIÓN MULTI-TENANT POR PUERTO
    # ========================================
    # Este servidor responde solo a localhost:8081
    # Misma configuración que el anterior pero con diferente X-Tenant-Host
    
    # Healthcheck del proxy
    location = /healthz { return 200 "ok\n"; }

    # ========================================
    # RUTAS API → BACKEND
    # ========================================
    location /api/ {
      proxy_pass http://backend;
      proxy_http_version 1.1;

      # Mismos timeouts que el servidor anterior
      proxy_read_timeout 180s;
      proxy_connect_timeout 5s;
      proxy_send_timeout 30s;

      # Headers básicos
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Port $server_port;
      
      # ========================================
      # HEADER CLAVE PARA MULTI-TENANT
      # ========================================
      # Este header le dice al backend que es "Distrito Padel"
      # El backend detectará este cliente y filtrará datos en consecuencia
      proxy_set_header X-Tenant-Host "distrito.localhost";

      # WebSockets
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
    }

    # ========================================
    # RUTAS FRONTEND → REACT CANCHAS
    # ========================================
    location / {
      proxy_pass http://frontend-canchas;
      proxy_http_version 1.1;

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Port $server_port;
    }

    # Headers de seguridad
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy no-referrer-when-downgrade always;
  }

}
